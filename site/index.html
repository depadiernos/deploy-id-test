<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="app">
      <div v-for="deploy in failedDeploys">
        {{`${deploy}`}}
      </div>
    </div>

    <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
    <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      // Initialise the Zendesk JavaScript API client
      // https://developer.zendesk.com/apps/docs/apps-v2
      // var client = ZAFClient.init()
      // client.invoke("resize", {
      //   width: "100%",
      //   height: "400px"
      // })
      var app = new Vue({
        el: "#app",
        data: {
          email: "",
          failedDeploys: [],
          test: "nothing"
        },
        mount() {
          this.setEmail()
          this.getInitialDeploys()
        },
        methods: {
          copy: (e) => {
            return document.execCommand("copy")
          },
          setEmail: async () => {
            const ticketData = await client.get("ticket.requester.email")
            app.email = ticketData["ticket.requester.email"] || "depadiernos@gmail.com"
          },
          getInitialDeploys: async () => {
            const data = await this.fetchDeploys()
            const parsedData = await data.json()
            app.failedDeploys = parsedData
            console.log(parsedData)
          },
          fetchDeploys: async () => {
            const deploys = await fetch(`/.netlify/functions/getdeploy`, {
              method: "POST",
              mode: "cors",
              body: JSON.stringify({
                email: email,
                deployId: deployId
              }),
              headers: {
                "Content-Type": "application/json",
                Authorization: "m51TdKUXYLw1p6eAQMv9wt4uAyRbmc1i"
              }
            })
            return deploys
          }
        }
      })
    </script>
  </body>
</html>
