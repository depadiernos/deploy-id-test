<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <!--   See Using Zendesk Garden:
    https://developer.zendesk.com/apps/docs/developer-guide/setup#using-zendesk-garden
    https://garden.zendesk.com/css-components/bedrock/
    https://garden.zendesk.com/css-components/utilities/typography/
   -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/combine/npm/@zendeskgarden/css-bedrock@7.0.21,npm/@zendeskgarden/css-utilities@4.3.0"
    />
  </head>
  <body>
    <div id="app">
      <div v-for="deploy in failedDeploys">
        {{`${deploy}`}}
      </div>
    </div>

    <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
    <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      // Initialise the Zendesk JavaScript API client
      // https://developer.zendesk.com/apps/docs/apps-v2
      var client = ZAFClient.init()
      client.invoke("resize", {
        width: "100%",
        height: "400px"
      })
      var app = new Vue({
        el: "#app",
        data: {
          failedDeploys: [],
          test: "nothing"
        },
        mount(){
          this.getInitialDeploys()
        },
        methods: {
          copy: (e) => {
            return document.execCommand("copy")
          },
          getInitialDeploys: async () => {
            const ticketData = await client.get("ticket.requester.email")
            const email = ticketData["ticket.requester.email"] || "depadiernos@gmail.com"
            const data = await this.fetchDeploys()
            const parsedData = await data.json()
            app.failedDeploys = parsedData
            console.log(parsedData)
          },
          fetchDeploys: async () => {
            await fetch(`/.netlify/functions/getdeploys`, {
              method: "POST", // or 'PUT'
              mode: "cors",
              body: JSON.stringify({
                email: email,
                deployId: deployId
              }), // data can be `string` or {object}!
              headers: {
                "Content-Type": "application/json",
                Authorization: "m51TdKUXYLw1p6eAQMv9wt4uAyRbmc1i"
              }
            })
          }
        }
      })
    </script>
  </body>
</html>
